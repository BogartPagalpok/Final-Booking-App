<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Illusive Admin | Elite Master v2.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,700;1,700&family=Plus+Jakarta+Sans:wght@300;400;800&display=swap" rel="stylesheet" />
    <style>
        :root {
            --accent: #7c5cff;
            --accent2: #a855f7;
            --bg0: #070814;
            --bg1: #0b0f2b;
            --text: rgba(255,255,255,0.92);
            --muted: rgba(255,255,255,0.65);
            --glass: rgba(255,255,255,0.06);
            --border: rgba(255,255,255,0.10);
            --border2: rgba(124,92,255,0.45);
            --font-serif: 'Cormorant Garamond', serif;
            --red: #ff4d6d;
            --green: #38f8b3;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; margin: 0; padding: 0; }
        body {
            background: radial-gradient(1200px 800px at 20% -10%, rgba(124,92,255,0.35), transparent 55%),
                        radial-gradient(900px 700px at 110% 10%, rgba(168,85,247,0.25), transparent 55%),
                        linear-gradient(180deg, var(--bg0), var(--bg1));
            color: var(--text);
            font-family: 'Plus Jakarta Sans', sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        .brand-serif { font-family: var(--font-serif); text-transform: uppercase; letter-spacing: 3px; font-weight: 700; font-style: italic; }
        
        /* PIN GATE */
        .gate-screen { position: fixed; inset: 0; background: linear-gradient(180deg, var(--bg0), var(--bg1)); z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.6s; }
        .gate-screen.unlocked { opacity: 0; pointer-events: none; transform: translateY(-100%); }
        .pin-dots { display: flex; gap: 15px; margin: 30px 0; }
        .dot { width: 14px; height: 14px; border: 2px solid rgba(124,92,255,0.85); border-radius: 50%; }
        .dot.filled { background: var(--accent); box-shadow: 0 0 18px rgba(124,92,255,0.75); }
        .numpad { display: grid; grid-template-columns: repeat(3, 80px); gap: 20px; }
        .num-btn {
            width: 80px; height: 80px; border-radius: 50%;
            border: 1px solid var(--border2);
            background: rgba(10,12,26,0.55);
            color: var(--text);
            font-size: 1.5rem; font-weight: 800; cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.35);
        }
        .gate-hint { margin-top: 18px; font-size: 10px; opacity: 0.55; letter-spacing: 2px; color: #bbb; text-align: center; min-height: 14px; }

        header { position: fixed; top: 0; width: 100%; padding: 18px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.08); background: rgba(8,10,24,0.65); z-index: 1000; backdrop-filter: blur(14px); }
        .tab-content { display: none; height: 100vh; overflow-y: auto; padding: 100px 20px 150px; width: 100%; }
        .tab-content.active { display: block; }

        .card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.09);
            border-radius: 22px;
            padding: 18px;
            margin-bottom: 14px;
            box-shadow: 0 18px 55px rgba(0,0,0,0.35);
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .date-tile { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 12px; border-radius: 10px; cursor: pointer; border: 1px solid transparent; }
        .date-tile.booked { border-color: rgba(124,92,255,0.8); color: #d8d1ff; background: rgba(124,92,255,0.12); font-weight: 800; }
        .date-tile.holiday { border-color: var(--red); color: var(--red); background: rgba(255,77,109,0.12); }
        
        .tab-bar { position: fixed; bottom: 0; width: 100%; display: flex; background: rgba(8,10,24,0.72); border-top: 1px solid rgba(255,255,255,0.08); padding: 14px 0 34px; z-index: 1000; backdrop-filter: blur(14px); }
        .tab-btn { flex: 1; text-align: center; font-size: 9px; font-weight: 800; color: rgba(255,255,255,0.45); cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        .tab-btn.active { color: #e8e4ff; }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(20px); z-index: 5000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal { width: 100%; max-width: 380px; background: rgba(8,10,24,0.78); border: 1px solid rgba(124,92,255,0.55); border-radius: 26px; padding: 26px; text-align: center; box-shadow: 0 30px 80px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 14px 14px; background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.10); border-radius: 16px; color: #fff; text-align: center; margin-bottom: 12px; }
        .primary-btn {
            width: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            border: none;
            padding: 14px 16px;
            border-radius: 16px;
            font-weight: 800;
            cursor: pointer;
            color: #0b0f2b;
            box-shadow: 0 18px 45px rgba(124,92,255,0.28);
        }
    </style>
</head>
<body>

    <section id="gate" class="gate-screen">
        <h2 class="brand-serif">Security</h2>
        <div class="pin-dots">
            <div class="dot" id="d0"></div><div class="dot" id="d1"></div><div class="dot" id="d2"></div><div class="dot" id="d3"></div>
        </div>
        <div class="numpad" id="pad"></div>
        <div id="gate-hint" class="gate-hint"></div>
    </section>

    <header><div class="brand-serif" id="hdr-title">Dashboard</div></header>

    <main id="tab-dash" class="tab-content active">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <button onclick="navMonth(-1)" style="background:none; border:none; color:rgba(232,228,255,0.9); font-size:1.2rem;">←</button>
                <span id="cur-month" class="brand-serif"></span>
                <button onclick="navMonth(1)" style="background:none; border:none; color:rgba(232,228,255,0.9); font-size:1.2rem;">→</button>
            </div>
            <div id="cal-grid" class="calendar-grid"></div>
        </div>
        <div class="card"><p style="font-size:10px; opacity:0.5; text-align:center;">Select a date to sync a manual booking.</p></div>
    </main>

    <main id="tab-prof" class="tab-content">
        <div class="card" style="text-align:center;">
            <div style="width:100px; height:100px; border-radius:50%; border:2px solid var(--gold); margin:0 auto 15px; overflow:hidden; background:#111;">
                <img id="profile-img" src="" alt="" style="width:100%; height:100%; object-fit:cover; display:none;" />
            </div>
            <button onclick="document.getElementById('pic-in').click()" style="background:none; border:1px solid var(--gold); color:var(--gold); font-size:8px; padding:6px 15px; border-radius:20px;">UPLOAD PHOTO</button>
            <input type="file" id="pic-in" hidden onchange="uploadPic(this)" />
            <input type="text" id="prof-name" class="brand-serif" style="background:none; border:none; color:#fff; text-align:center; width:100%; margin-top:15px; font-size:1.5rem;" onchange="syncProfile()" placeholder="Brand Name" />
        </div>
        <button onclick="logout()" class="card" style="width:100%; color:var(--red); border-color:var(--red); font-size:10px; font-weight:800; text-transform:uppercase;">Logout</button>
    </main>

    <main id="tab-rev" class="tab-content">
        <div class="card" style="text-align:center;">
            <p style="font-size:8px; color:var(--gold); letter-spacing:2px;">TOTAL PROFIT</p>
            <h1 id="stat-profit" style="font-size:2.5rem; color:var(--gold); margin:10px 0;">₱0</h1>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; border-top:1px solid var(--glass); padding-top:15px;">
                <div><p style="font-size:7px; opacity:0.5;">REVENUE</p><h3 id="stat-rev" style="color:var(--green);">₱0</h3></div>
                <div><p style="font-size:7px; opacity:0.5;">EXPENSES</p><h3 id="stat-exp" style="color:var(--red);">₱0</h3></div>
            </div>
        </div>
        <div class="card">
            <p class="brand-serif" style="font-size:10px; margin-bottom:15px;">Log Expense</p>
            <input type="text" id="exp-name" placeholder="Supply Name" />
            <input type="number" id="exp-amt" placeholder="Amount (PHP)" />
            <button class="primary-btn" onclick="addExpense()">Add to Ledger</button>
        </div>
    </main>

    <main id="tab-log" class="tab-content">
        <div id="feed-list"></div>
    </main>

    <div id="modal-date" class="overlay">
        <div class="modal">
            <h2 id="pop-title" class="brand-serif" style="color:var(--gold); margin-bottom:15px;"></h2>
            <div id="date-details" style="font-size:11px; margin-bottom:20px; text-align:left; color:#ccc;"></div>
            <input type="text" id="walkin-name" placeholder="CLIENT NAME" />
            <button class="primary-btn" onclick="addManual()">Confirm Sync</button>
            <button onclick="closePop()" style="background:none; border:none; color:#555; margin-top:20px; font-size:10px;">CLOSE</button>
        </div>
    </div>

    <nav class="tab-bar">
        <div class="tab-btn active" onclick="switchTab('dash', this)">Dashboard</div>
        <div class="tab-btn" onclick="switchTab('prof', this)">Profile</div>
        <div class="tab-btn" onclick="switchTab('rev', this)">Revenue</div>
        <div class="tab-btn" onclick="switchTab('log', this)">Logbook</div>
    </nav>

    <script>
        const PIN = "1029";
        const API = "https://script.google.com/macros/s/AKfycbz_AJZgK7zbczP7-kwm7GDirtkVr7gUDmB65cAiALiMANYs97ubKMw6k_M8cTLvOXPy/exec";

        let curPin = "", db = [], viewDate = new Date(), activeD = "";
        let manual = JSON.parse(localStorage.getItem('ill_manual') || '[]');
        let expenses = JSON.parse(localStorage.getItem('ill_expenses') || '[]');

        function normalizeDateKey(d) {
            return String(d || '').split('T')[0];
        }

        function dedupeBookings(list) {
            const seen = new Set();
            const out = [];
            for (const b of (Array.isArray(list) ? list : [])) {
                const name = (b && b.name != null) ? String(b.name).trim() : "";
                const date = normalizeDateKey(b && b.date);
                if (!name || !date) continue;
                const key = `${date}__${name}`;
                if (seen.has(key)) continue;
                seen.add(key);
                out.push({ ...b, name, date: b.date || date });
            }
            return out;
        }

        function bookingRevKey(b) {
            const date = normalizeDateKey(b && b.date);
            const name = (b && b.name != null) ? String(b.name).trim() : "";
            const safeName = name.replace(/\s+/g, ' ').slice(0, 80);
            return `c_${date}_${safeName}`;
        }

        function getBookingRevenue(b) {
            const kNew = bookingRevKey(b);
            const vNew = localStorage.getItem(kNew);
            if (vNew != null && vNew !== "") return vNew;

            // Back-compat: older versions keyed revenue by name only.
            const legacyKey = `c_${(b && b.name != null) ? String(b.name) : ""}`;
            const vLegacy = localStorage.getItem(legacyKey);
            if (vLegacy != null && vLegacy !== "") {
                localStorage.setItem(kNew, vLegacy);
                return vLegacy;
            }
            return "";
        }

        function press(n) {
            if (curPin.length < 4) {
                curPin += n;
                upDots();
                if (curPin.length === 4) check();
            }
        }

        function upDots() {
            for (let i = 0; i < 4; i++) {
                document.getElementById('d' + i).className = (i < curPin.length) ? 'dot filled' : 'dot';
            }
        }

        function setGateHint(msg) {
            const el = document.getElementById('gate-hint');
            if (el) el.textContent = msg || "";
        }

        function check() {
            if (curPin === PIN) {
                setGateHint("");
                document.getElementById('gate').classList.add('unlocked');
                load();
            } else {
                setGateHint("Incorrect PIN");
                curPin = "";
                upDots();
            }
        }

        function syncProfile() {
            const name = (document.getElementById('prof-name').value || "").trim();
            localStorage.setItem('ill_name', name);
        }

        function logout() {
            // Keeps local data by default; just re-locks.
            location.reload();
        }

        function initLocalUi() {
            const savedName = localStorage.getItem('ill_name') || "";
            const nameEl = document.getElementById('prof-name');
            if (nameEl && !nameEl.value) nameEl.value = savedName;

            const pic = localStorage.getItem('ill_pic');
            if (pic) {
                const img = document.getElementById('profile-img');
                img.src = pic;
                img.style.display = 'block';
            }
        }

        async function load() {
            const savedName = localStorage.getItem('ill_name') || "";
            const nameEl = document.getElementById('prof-name');
            if (nameEl && !nameEl.value) nameEl.value = savedName;

            const pic = localStorage.getItem('ill_pic');
            if (pic) {
                const img = document.getElementById('profile-img');
                img.src = pic;
                img.style.display = 'block';
            }

            try {
                const res = await fetch(API, { cache: 'no-store' });
                const remote = await res.json();
                db = dedupeBookings([...(Array.isArray(remote) ? remote : []), ...manual]);
                render();
            } catch (e) {
                db = dedupeBookings([...manual]);
                render();
            }
        }

        function render() {
            const y = viewDate.getFullYear(), m = viewDate.getMonth();
            document.getElementById('cur-month').innerText = viewDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            const start = new Date(y, m, 1).getDay(), end = new Date(y, m + 1, 0).getDate();
            let html = "";
            for (let i = 0; i < start; i++) html += `<div></div>`;
            for (let i = 1; i <= end; i++) {
                const key = `${y}-${String(m + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const hasBook = db.some(b => normalizeDateKey(b.date) === key);
                html += `<div class="date-tile ${hasBook ? 'booked' : ''}" onclick="openDate('${key}')">${i}</div>`;
            }
            document.getElementById('cal-grid').innerHTML = html;
            renderList();
            updateStats();
        }

        function escapeHtml(s) {
            return String(s || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderList() {
            document.getElementById('feed-list').innerHTML = [...db].reverse().map(b => {
                const rev = getBookingRevenue(b);
                const key = bookingRevKey(b);
                const d = normalizeDateKey(b.date);
                const safeKey = key.replace(/'/g, "\\'");
                const style = escapeHtml(b.style || '');
                const time = escapeHtml(b.time || '');
                const ref = escapeHtml(b.referral || b.ref || '');
                return `
                    <div class="card">
                        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
                            <div>
                                <p style="font-size:8px; color:var(--gold); font-weight:800;">${d}</p>
                                <h3 class="brand-serif" style="margin-top:6px;">${escapeHtml(b.name)}</h3>
                                <p style="font-size:10px; opacity:0.7; margin-top:8px; line-height:1.4;">
                                    ${style ? `<span style="color:var(--gold); font-weight:800;">${style}</span>` : ''}
                                    ${time ? `<span style="margin-left:8px; color:#bbb;">${time}</span>` : ''}
                                    ${ref ? `<br><span style="color:#777;">Ref: ${ref}</span>` : ''}
                                </p>
                            </div>
                        </div>
                        <input type="number" value="${rev}" onchange="saveRev('${safeKey}', this.value)" placeholder="Enter PHP" style="margin-top:12px; color:var(--green); font-weight:800;">
                    </div>
                `;
            }).join('');
        }

        async function addManual() {
            const name = (document.getElementById('walkin-name').value || "").trim();
            if (!name || !activeD) return;

            const entry = { name: name + " (M)", date: activeD, style: "Complex", time: "TBA", referral: "None" };
            try {
                await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify(entry) });
            } catch (_) {
                // Offline / blocked: still save locally.
            }
            manual.push(entry);
            manual = dedupeBookings(manual);
            localStorage.setItem('ill_manual', JSON.stringify(manual));
            document.getElementById('walkin-name').value = "";
            closePop();
            load();
        }

        function updateStats() {
            const totalRev = db.reduce((acc, b) => acc + parseFloat(getBookingRevenue(b) || 0), 0);
            const totalExp = expenses.reduce((acc, e) => acc + (parseFloat(e && e.amt) || 0), 0);
            document.getElementById('stat-rev').innerText = "₱" + totalRev.toLocaleString();
            document.getElementById('stat-exp').innerText = "₱" + totalExp.toLocaleString();
            document.getElementById('stat-profit').innerText = "₱" + (totalRev - totalExp).toLocaleString();
        }

        function openDate(d) {
            activeD = d;
            document.getElementById('pop-title').innerText = d;
            const matches = db.filter(b => normalizeDateKey(b.date) === d);
            document.getElementById('date-details').innerHTML =
                matches.length > 0 ? matches.map(b => {
                    const name = escapeHtml(b.name);
                    const st = escapeHtml(b.style || '');
                    const tm = escapeHtml(b.time || '');
                    return `• ${name}${st ? ` <span style="opacity:0.7">(${st}${tm ? `, ${tm}` : ''})</span>` : ''}`;
                }).join('<br>') : "No sessions.";
            document.getElementById('modal-date').style.display = "flex";
        }

        function switchTab(t, el) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + t).classList.add('active');
            el.classList.add('active');
            document.getElementById('hdr-title').innerText = el.innerText;
        }

        function addExpense() {
            const n = (document.getElementById('exp-name').value || "").trim();
            const a = parseFloat(document.getElementById('exp-amt').value);
            if (!n || !isFinite(a) || a <= 0) return;
            expenses.push({ name: n, amt: a, ts: Date.now() });
            localStorage.setItem('ill_expenses', JSON.stringify(expenses));
            document.getElementById('exp-name').value = "";
            document.getElementById('exp-amt').value = "";
            updateStats();
        }

        function saveRev(storageKey, val) {
            localStorage.setItem(storageKey, val);
            updateStats();
        }

        function uploadPic(input) {
            const file = input && input.files && input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                localStorage.setItem('ill_pic', e.target.result);
                const img = document.getElementById('profile-img');
                img.src = e.target.result;
                img.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function closePop() {
            document.getElementById('modal-date').style.display = "none";
        }

        function navMonth(d) {
            viewDate.setMonth(viewDate.getMonth() + d);
            render();
        }

        const pad = document.getElementById('pad');
        [1,2,3,4,5,6,7,8,9,'C',0,'X'].forEach(v => {
            const b = document.createElement('button');
            b.className = "num-btn";
            b.innerText = v;
            b.onclick = () => {
                if (v === 'C') {
                    curPin = "";
                    setGateHint("");
                    upDots();
                } else if (v === 'X') {
                    location.reload();
                } else {
                    press(v);
                }
            };
            pad.appendChild(b);
        });

        // Init
        initLocalUi();
    </script>
</body>
</html>

